# Data ordering - bin-packer with Apache Spark and Apache Kafka

------

⚠️ Apache Kafka is not a data store with partial commits semantic but at the same time it's one of the most popular streaming brokers. The popularity
is the reason of its presence in the demo. 
If you are looking for a pure example for partial commits, check the example with Amazon Kinesis Data Streams.

---

1. Start Apache Kafka broker and generate the dataset:
```
cd docker
docker-compose down --volumes; docker-compose up
```

2. Explain the [bin_pack_orderer_job.py](bin_pack_orderer_job.py)
* the job performs the bin-ordering in two parts:
  * first, in the `write_sorted_events` it sorts all records by visit_id and event_time, so that the bins creator
    can simply create groups
  * second, the `write_records_to_kafka` function creates delivery groups by iterating the incoming rows and putting
    events for a given visit in different delivery bins
3. Run the `bin_pack_orderer_job.py`
4. Consume the data from the output topic:
```
docker exec dedp_ch05_bin_packer_kafka kafka-console-consumer.sh --topic visits-ordered --bootstrap-server localhost:9092 --property print.timestamp=true  --property print.headers=true  

CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_1", "event_time": "2024-01-01T02:56:00+00:00", "user_id": "140177386105728_cfeeaf2a-9a09-4989-9049-7d1982f2ec16", "keep_private": false, "page": "main", "context": {"referral": "Twitter", "ad_id": null, "user": {"ip": "133.184.20.112", "login": "lauraburke", "connected_since": "2023-12-28T00:00:00+00:00"}, "technical": {"browser": "Firefox", "browser_version": "24.11", "network_type": "4G", "device_type": "Smartphone", "device_version": "3.0"}}}
CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_10", "event_time": "2024-01-01T00:00:00+00:00", "user_id": "140177386105728_ad4d7b1f-358a-42ea-9388-baec2fca06c7", "keep_private": false, "page": "category_19", "context": {"referral": null, "ad_id": "ad 1", "user": {"ip": "18.106.61.69", "login": "jaredstewart", "connected_since": "2023-12-05T00:00:00+00:00"}, "technical": {"browser": "Firefox", "browser_version": "23.0", "network_type": "Wi-Fi", "device_type": "PC", "device_version": "1.0"}}}
CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_2", "event_time": "2024-01-01T03:08:00+00:00", "user_id": "140177386105728_ef9f7a75-277e-4dbb-8446-076a43237d66", "keep_private": false, "page": "category_8", "context": {"referral": "StackOverflow", "ad_id": null, "user": {"ip": "60.135.200.110", "login": "sandra17", "connected_since": null}, "technical": {"browser": "Chrome", "browser_version": "20.1", "network_type": "Wi-Fi", "device_type": "iPad", "device_version": "1.0"}}}
CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_3", "event_time": "2024-01-01T02:57:22+00:00", "user_id": "140177386105728_0319cbab-73ff-4963-836b-072014e69ee0", "keep_private": false, "page": "categories", "context": {"referral": "LinkedIn", "ad_id": "ad 5", "user": {"ip": "86.131.220.213", "login": "jasmin85", "connected_since": null}, "technical": {"browser": "Safari", "browser_version": "20.0", "network_type": "4G", "device_type": "iPad", "device_version": "1.0"}}}
CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_4", "event_time": "2024-01-01T03:29:16+00:00", "user_id": "140177386105728_a6617934-af14-4592-bc97-0babf18c8504", "keep_private": false, "page": "main", "context": {"referral": null, "ad_id": "ad 2", "user": {"ip": "106.166.44.206", "login": "drakejulie", "connected_since": null}, "technical": {"browser": "Firefox", "browser_version": "24.11", "network_type": "5G", "device_type": "iPad", "device_version": "4.0"}}}
CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_5", "event_time": "2024-01-01T02:59:00+00:00", "user_id": "140177386105728_0b88df9c-5ec9-455a-a791-71d7596f4d82", "keep_private": false, "page": "about", "context": {"referral": "Medium", "ad_id": "ad 3", "user": {"ip": "161.19.84.151", "login": "stacy97", "connected_since": "2023-12-31T00:00:00+00:00"}, "technical": {"browser": "Safari", "browser_version": "20.2", "network_type": "Wi-Fi", "device_type": "iPhone", "device_version": "1.0"}}}
CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_6", "event_time": "2024-01-01T02:49:00+00:00", "user_id": "140177386105728_329c77c3-32ea-4ec0-98c7-acb5f172cc04", "keep_private": false, "page": "index", "context": {"referral": "LinkedIn", "ad_id": "ad 5", "user": {"ip": "28.253.146.46", "login": "zfoster", "connected_since": null}, "technical": {"browser": "Firefox", "browser_version": "20.2", "network_type": "5G", "device_type": "iPhone", "device_version": "5.0"}}}
CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_7", "event_time": "2024-01-01T03:04:00+00:00", "user_id": "140177386105728_02ba724e-895e-4319-9e32-18c41881ef6d", "keep_private": false, "page": "index", "context": {"referral": "Facebook", "ad_id": null, "user": {"ip": "85.131.203.78", "login": "zfarrell", "connected_since": "2023-12-06T00:00:00+00:00"}, "technical": {"browser": "Safari", "browser_version": "23.1", "network_type": "4G", "device_type": "PC", "device_version": "6.0"}}}
CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_8", "event_time": "2024-01-01T03:19:00+00:00", "user_id": "140177386105728_a519c67b-d730-4b10-b528-f3c3a4258437", "keep_private": false, "page": "index", "context": {"referral": "Twitter", "ad_id": null, "user": {"ip": "164.244.216.33", "login": "colleengarcia", "connected_since": null}, "technical": {"browser": "Chrome", "browser_version": "23.0", "network_type": "Wi-Fi", "device_type": "PC", "device_version": "5.0"}}}
CreateTime:1709470680728	delivery_batch:1	{"visit_id": "140177386105728_9", "event_time": "2024-01-01T02:39:50+00:00", "user_id": "140177386105728_1a506899-1fa7-4617-b6ec-d5dd1397848b", "keep_private": false, "page": "categories", "context": {"referral": "Twitter", "ad_id": "ad 1", "user": {"ip": "86.50.56.230", "login": "michael61", "connected_since": null}, "technical": {"browser": "Firefox", "browser_version": "23.1", "network_type": "4G", "device_type": "PC", "device_version": "3.0"}}}

CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_0", "event_time": "2024-01-01T03:23:00+00:00", "user_id": "140177386105728_616a3178-e4b1-4ce9-a85a-e864b4b5f2b9", "keep_private": false, "page": "categories", "context": {"referral": "Facebook", "ad_id": "ad 5", "user": {"ip": "200.136.44.79", "login": "elizabethlopez", "connected_since": "2023-12-11T00:00:00+00:00"}, "technical": {"browser": "Safari", "browser_version": "23.0", "network_type": "Wi-Fi", "device_type": "MacBook", "device_version": "6.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_1", "event_time": "2024-01-01T02:58:00+00:00", "user_id": "140177386105728_cfeeaf2a-9a09-4989-9049-7d1982f2ec16", "keep_private": false, "page": "contact", "context": {"referral": "Twitter", "ad_id": null, "user": {"ip": "133.184.20.112", "login": "lauraburke", "connected_since": "2023-12-28T00:00:00+00:00"}, "technical": {"browser": "Firefox", "browser_version": "24.11", "network_type": "4G", "device_type": "Smartphone", "device_version": "3.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_10", "event_time": "2024-01-01T00:01:00+00:00", "user_id": "140177386105728_ad4d7b1f-358a-42ea-9388-baec2fca06c7", "keep_private": false, "page": "index", "context": {"referral": null, "ad_id": "ad 1", "user": {"ip": "18.106.61.69", "login": "jaredstewart", "connected_since": "2023-12-05T00:00:00+00:00"}, "technical": {"browser": "Firefox", "browser_version": "23.0", "network_type": "Wi-Fi", "device_type": "PC", "device_version": "1.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_2", "event_time": "2024-01-01T03:09:00+00:00", "user_id": "140177386105728_ef9f7a75-277e-4dbb-8446-076a43237d66", "keep_private": false, "page": "categories", "context": {"referral": "StackOverflow", "ad_id": null, "user": {"ip": "60.135.200.110", "login": "sandra17", "connected_since": null}, "technical": {"browser": "Chrome", "browser_version": "20.1", "network_type": "Wi-Fi", "device_type": "iPad", "device_version": "1.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_3", "event_time": "2024-01-01T03:02:22+00:00", "user_id": "140177386105728_0319cbab-73ff-4963-836b-072014e69ee0", "keep_private": false, "page": "page_19", "context": {"referral": "LinkedIn", "ad_id": "ad 5", "user": {"ip": "86.131.220.213", "login": "jasmin85", "connected_since": null}, "technical": {"browser": "Safari", "browser_version": "20.0", "network_type": "4G", "device_type": "iPad", "device_version": "1.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_4", "event_time": "2024-01-01T03:32:16+00:00", "user_id": "140177386105728_a6617934-af14-4592-bc97-0babf18c8504", "keep_private": false, "page": "page_1", "context": {"referral": null, "ad_id": "ad 2", "user": {"ip": "106.166.44.206", "login": "drakejulie", "connected_since": null}, "technical": {"browser": "Firefox", "browser_version": "24.11", "network_type": "5G", "device_type": "iPad", "device_version": "4.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_5", "event_time": "2024-01-01T03:02:00+00:00", "user_id": "140177386105728_0b88df9c-5ec9-455a-a791-71d7596f4d82", "keep_private": false, "page": "categories", "context": {"referral": "Medium", "ad_id": "ad 3", "user": {"ip": "161.19.84.151", "login": "stacy97", "connected_since": "2023-12-31T00:00:00+00:00"}, "technical": {"browser": "Safari", "browser_version": "20.2", "network_type": "Wi-Fi", "device_type": "iPhone", "device_version": "1.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_6", "event_time": "2024-01-01T02:52:00+00:00", "user_id": "140177386105728_329c77c3-32ea-4ec0-98c7-acb5f172cc04", "keep_private": false, "page": "page_5", "context": {"referral": "LinkedIn", "ad_id": "ad 5", "user": {"ip": "28.253.146.46", "login": "zfoster", "connected_since": null}, "technical": {"browser": "Firefox", "browser_version": "20.2", "network_type": "5G", "device_type": "iPhone", "device_version": "5.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_7", "event_time": "2024-01-01T03:07:00+00:00", "user_id": "140177386105728_02ba724e-895e-4319-9e32-18c41881ef6d", "keep_private": false, "page": "main", "context": {"referral": "Facebook", "ad_id": null, "user": {"ip": "85.131.203.78", "login": "zfarrell", "connected_since": "2023-12-06T00:00:00+00:00"}, "technical": {"browser": "Safari", "browser_version": "23.1", "network_type": "4G", "device_type": "PC", "device_version": "6.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_8", "event_time": "2024-01-01T03:24:00+00:00", "user_id": "140177386105728_a519c67b-d730-4b10-b528-f3c3a4258437", "keep_private": false, "page": "category_20", "context": {"referral": "Twitter", "ad_id": null, "user": {"ip": "164.244.216.33", "login": "colleengarcia", "connected_since": null}, "technical": {"browser": "Chrome", "browser_version": "23.0", "network_type": "Wi-Fi", "device_type": "PC", "device_version": "5.0"}}}
CreateTime:1709470680732	delivery_batch:2	{"visit_id": "140177386105728_9", "event_time": "2024-01-01T02:44:50+00:00", "user_id": "140177386105728_1a506899-1fa7-4617-b6ec-d5dd1397848b", "keep_private": false, "page": "categories", "context": {"referral": "Twitter", "ad_id": "ad 1", "user": {"ip": "86.50.56.230", "login": "michael61", "connected_since": null}, "technical": {"browser": "Firefox", "browser_version": "23.1", "network_type": "4G", "device_type": "PC", "device_version": "3.0"}}}

CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_0", "event_time": "2024-01-01T03:26:00+00:00", "user_id": "140177386105728_616a3178-e4b1-4ce9-a85a-e864b4b5f2b9", "keep_private": false, "page": "page_8", "context": {"referral": "Facebook", "ad_id": "ad 5", "user": {"ip": "200.136.44.79", "login": "elizabethlopez", "connected_since": "2023-12-11T00:00:00+00:00"}, "technical": {"browser": "Safari", "browser_version": "23.0", "network_type": "Wi-Fi", "device_type": "MacBook", "device_version": "6.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_1", "event_time": "2024-01-01T03:02:00+00:00", "user_id": "140177386105728_cfeeaf2a-9a09-4989-9049-7d1982f2ec16", "keep_private": false, "page": "main", "context": {"referral": "Twitter", "ad_id": null, "user": {"ip": "133.184.20.112", "login": "lauraburke", "connected_since": "2023-12-28T00:00:00+00:00"}, "technical": {"browser": "Firefox", "browser_version": "24.11", "network_type": "4G", "device_type": "Smartphone", "device_version": "3.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_10", "event_time": "2024-01-01T00:03:00+00:00", "user_id": "140177386105728_ad4d7b1f-358a-42ea-9388-baec2fca06c7", "keep_private": false, "page": "home", "context": {"referral": null, "ad_id": "ad 1", "user": {"ip": "18.106.61.69", "login": "jaredstewart", "connected_since": "2023-12-05T00:00:00+00:00"}, "technical": {"browser": "Firefox", "browser_version": "23.0", "network_type": "Wi-Fi", "device_type": "PC", "device_version": "1.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_2", "event_time": "2024-01-01T03:14:00+00:00", "user_id": "140177386105728_ef9f7a75-277e-4dbb-8446-076a43237d66", "keep_private": false, "page": "category_1", "context": {"referral": "StackOverflow", "ad_id": null, "user": {"ip": "60.135.200.110", "login": "sandra17", "connected_since": null}, "technical": {"browser": "Chrome", "browser_version": "20.1", "network_type": "Wi-Fi", "device_type": "iPad", "device_version": "1.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_3", "event_time": "2024-01-01T03:05:22+00:00", "user_id": "140177386105728_0319cbab-73ff-4963-836b-072014e69ee0", "keep_private": false, "page": "main", "context": {"referral": "LinkedIn", "ad_id": "ad 5", "user": {"ip": "86.131.220.213", "login": "jasmin85", "connected_since": null}, "technical": {"browser": "Safari", "browser_version": "20.0", "network_type": "4G", "device_type": "iPad", "device_version": "1.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_4", "event_time": "2024-01-01T03:33:16+00:00", "user_id": "140177386105728_a6617934-af14-4592-bc97-0babf18c8504", "keep_private": false, "page": "index", "context": {"referral": null, "ad_id": "ad 2", "user": {"ip": "106.166.44.206", "login": "drakejulie", "connected_since": null}, "technical": {"browser": "Firefox", "browser_version": "24.11", "network_type": "5G", "device_type": "iPad", "device_version": "4.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_5", "event_time": "2024-01-01T03:06:00+00:00", "user_id": "140177386105728_0b88df9c-5ec9-455a-a791-71d7596f4d82", "keep_private": false, "page": "about", "context": {"referral": "Medium", "ad_id": "ad 3", "user": {"ip": "161.19.84.151", "login": "stacy97", "connected_since": "2023-12-31T00:00:00+00:00"}, "technical": {"browser": "Safari", "browser_version": "20.2", "network_type": "Wi-Fi", "device_type": "iPhone", "device_version": "1.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_6", "event_time": "2024-01-01T02:55:00+00:00", "user_id": "140177386105728_329c77c3-32ea-4ec0-98c7-acb5f172cc04", "keep_private": false, "page": "about", "context": {"referral": "LinkedIn", "ad_id": "ad 5", "user": {"ip": "28.253.146.46", "login": "zfoster", "connected_since": null}, "technical": {"browser": "Firefox", "browser_version": "20.2", "network_type": "5G", "device_type": "iPhone", "device_version": "5.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_7", "event_time": "2024-01-01T03:09:00+00:00", "user_id": "140177386105728_02ba724e-895e-4319-9e32-18c41881ef6d", "keep_private": false, "page": "page_11", "context": {"referral": "Facebook", "ad_id": null, "user": {"ip": "85.131.203.78", "login": "zfarrell", "connected_since": "2023-12-06T00:00:00+00:00"}, "technical": {"browser": "Safari", "browser_version": "23.1", "network_type": "4G", "device_type": "PC", "device_version": "6.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_8", "event_time": "2024-01-01T03:26:00+00:00", "user_id": "140177386105728_a519c67b-d730-4b10-b528-f3c3a4258437", "keep_private": false, "page": "category_5", "context": {"referral": "Twitter", "ad_id": null, "user": {"ip": "164.244.216.33", "login": "colleengarcia", "connected_since": null}, "technical": {"browser": "Chrome", "browser_version": "23.0", "network_type": "Wi-Fi", "device_type": "PC", "device_version": "5.0"}}}
CreateTime:1709470680734	delivery_batch:3	{"visit_id": "140177386105728_9", "event_time": "2024-01-01T02:47:50+00:00", "user_id": "140177386105728_1a506899-1fa7-4617-b6ec-d5dd1397848b", "keep_private": false, "page": "index", "context": {"referral": "Twitter", "ad_id": "ad 1", "user": {"ip": "86.50.56.230", "login": "michael61", "connected_since": null}, "technical": {"browser": "Firefox", "browser_version": "23.1", "network_type": "4G", "device_type": "PC", "device_version": "3.0"}}}
```

The timestamp and the _deliver_batch_ header should indicate what are the visits delivered together. You can see that there is always 
a single visit_id per group. 
